const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// Security middleware
app.use(helmet({
    crossOriginEmbedderPolicy: false,
}));

app.use(cors({
    origin: function (origin, callback) {
        // Allow requests with no origin (like mobile apps or curl requests)
        if (!origin) return callback(null, true);
        
        // Allow any localhost or 127.0.0.1 with any port (for development)
        if (origin && origin.match(/^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?$/)) {
            return callback(null, true);
        }
        
        // Add your Infomaniak domain here
        const allowedOrigins = [
            'http://localhost:3000',
            'http://localhost:5500',
            'http://localhost:5501',
            'http://localhost:5502',
            'http://127.0.0.1:5500',
            'http://127.0.0.1:5501',
            'http://127.0.0.1:5502',
            'https://mirasens.com', // Replace with your actual Infomaniak domain
            'https://your-subdomain.infomaniak.website', // Replace with your actual domain
            // Add more domains as needed
        ];
        
        if (allowedOrigins.includes(origin)) {
            return callback(null, true);
        }
        
        // For development, allow all origins
        if (process.env.NODE_ENV === 'development') {
            return callback(null, true);
        }
        
        // For production, be more permissive with HTTPS domains
        if (process.env.NODE_ENV === 'production' && origin && origin.startsWith('https://')) {
            return callback(null, true);
        }
        
        // Reject other origins
        callback(new Error('Not allowed by CORS'));
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
    preflightContinue: false,
    optionsSuccessStatus: 200
}));

// Rate limiting
const limiter = rateLimit({
    windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS) || 15 * 60 * 1000, // 15 minutes
    max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS) || 100,
    message: {
        error: 'Too many requests from this IP, please try again later.'
    }
});
app.use('/api/', limiter);

// Body parser
app.use(express.json({ limit: '10mb' }));

// Initialize Gemini AI
let model = null;
if (process.env.GEMINI_API_KEY && process.env.GEMINI_API_KEY !== 'your_gemini_api_key_here') {
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    console.log('‚úÖ Gemini AI initialized successfully');
} else {
    console.log('‚ö†Ô∏è  Gemini API key not configured. Server will run in demo mode.');
}

// MIRASENS Comprehensive Knowledge Base
const MIRASENS_KNOWLEDGE = {
    fr: {
        company: `MIRASENS est une entreprise sp√©cialis√©e dans l'Internet des Objets (IoT) et les solutions de connectivit√© M2M bas√©e √† Dounia Parc, Dely Brahim, Alger, Alg√©rie.

CONTACT:
T√©l√©phone: (+213) 560-555-300
Email: contact@mirasens.com
Site web: www.mirasens.com

SECTEURS D'ACTIVIT√â D√âTAILL√âS:

üêü SMART AQUACULTURE:
Technologies: Surveillance qualit√© eau, croissance poissons, syst√®mes alimentation automatis√©s
‚Ä¢ Surveillance eau: Temp√©rature, pH, oxyg√®ne dissous, ammoniac, nitrites, turbidit√©, conductivit√©
‚Ä¢ Gestion alimentation: Syst√®mes automatis√©s, optimisation nutriments
‚Ä¢ Croissance poissons: Suivi biom√©trique, analyse comportement
‚Ä¢ Plateforme FishFlow d√©di√©e
FAQ Aquaculture:
- Capteurs surveillent temp√©rature, pH, oxyg√®ne, conductivit√© en temps r√©el
- Alertes automatiques en cas de d√©passement seuils
- R√©duction mortalit√© jusqu'√† 30%, am√©lioration rendements
- Compatible bassins existants, installation simple
- ROI moyen 12-18 mois

üå± SMART AGRICULTURE:
Technologies: Surveillance sol, optimisation irrigation, analyse sant√© cultures
‚Ä¢ Surveillance sol: Humidit√©, temp√©rature, niveaux nutritifs, pH
‚Ä¢ Stations m√©t√©o: Pluie, vent, humidit√©, pression atmosph√©rique
‚Ä¢ Irrigation intelligente: Contr√¥le automatis√© bas√© conditions
‚Ä¢ Sant√© cultures: D√©tection pr√©coce maladies/parasites
FAQ Agriculture:
- Capteurs sol surveillent humidit√©, temp√©rature, NPK
- √âconomies eau 20-40%, am√©lioration rendements 15-25%
- Installation sans perturbation cultures existantes
- Compatibilit√© syst√®mes irrigation actuels
- Support technique et formation inclus

üè≠ SMART INDUSTRY:
Technologies: Maintenance pr√©dictive, surveillance √©quipements, optimisation production
‚Ä¢ Capteurs vibration, temp√©rature, pression, acoustique
‚Ä¢ Algorithmes IA pour pr√©diction pannes
‚Ä¢ Tableaux bord temps r√©el
‚Ä¢ Optimisation processus production
FAQ Industrie:
- R√©duction pannes non planifi√©es jusqu'√† 50%
- Optimisation maintenance, extension dur√©e vie √©quipements
- Surveillance continue 24/7 avec alertes
- Int√©gration ERP/MES existants
- Formation √©quipes maintenance

üöõ SMART LOGISTIQUE:
Technologies: Suivi d'actifs, optimisation routes, surveillance cha√Æne froid
‚Ä¢ G√©olocalisation v√©hicules/marchandises GPS temps r√©el
‚Ä¢ Surveillance temp√©rature cha√Æne froid
‚Ä¢ Optimisation routes/livraisons
‚Ä¢ Gestion flotte compl√®te
FAQ Logistique:
- Tra√ßabilit√© compl√®te produits via IoT/RFID/QR codes
- R√©duction co√ªts transport, am√©lioration d√©lais livraison
- Collecte donn√©es: temp√©rature, humidit√©, g√©olocalisation, consommation
- Connectivit√© entrep√¥ts existants via passerelles/API
- Mise en place: analyse besoins ‚Üí capteurs ‚Üí pilote ‚Üí d√©ploiement

üè¢ SMART BUILDING:
Technologies: Gestion √©nergie, syst√®mes s√©curit√©, optimisation occupation
‚Ä¢ Contr√¥le √©clairage, chauffage, climatisation
‚Ä¢ D√©tection pr√©sence, qualit√© air
‚Ä¢ S√©curit√© acc√®s, surveillance
‚Ä¢ Optimisation consommation √©nerg√©tique

üöó GESTION DE FLOTTES:
Technologies: Suivi v√©hicules, optimisation carburant, planification maintenance
‚Ä¢ G√©olocalisation temps r√©el
‚Ä¢ Consommation carburant, √©co-conduite
‚Ä¢ Maintenance pr√©ventive
‚Ä¢ Planification tourn√©es optimales

SOLUTIONS LOGICIELLES D√âTAILL√âES:

üêü FISHFLOW - Plateforme aquaculture/agriculture:
‚Ä¢ Supervision multi-√©quipements et multi-r√©seaux
‚Ä¢ Analyse donn√©es temps r√©el, aide d√©cision
‚Ä¢ Tableaux bord personnalisables
‚Ä¢ Syst√®me alertes performances
‚Ä¢ Widgets: graphiques, jauges, cartes, timelines
‚Ä¢ Localisation dynamique objets
‚Ä¢ Gestion droits acc√®s utilisateurs
‚Ä¢ IA embarqu√©e pour pr√©dictions
‚Ä¢ Gestion alimentation automatis√©e
‚Ä¢ H√©bergement: SaaS (abonnement) ou On-Premise (licence)

üìä M-IoT - Plateforme tout-en-un:
‚Ä¢ Gestion et visualisation multi-objets
‚Ä¢ Connectivit√© multi-protocoles
‚Ä¢ Analytics avanc√©s
‚Ä¢ Tableaux bord configurables
‚Ä¢ Alertes intelligentes

üìç SirGPS - Gestion flottes:
‚Ä¢ Application web/mobile
‚Ä¢ G√©olocalisation temps r√©el
‚Ä¢ Optimisation routes
‚Ä¢ Gestion carburant
‚Ä¢ Maintenance v√©hicules
‚Ä¢ Rapports d√©taill√©s

TECHNOLOGIES SUPPORT√âES:
‚Ä¢ Protocoles: LoRaWAN, Sigfox, NB-IoT, LTE-M, WiFi, Bluetooth, RFID
‚Ä¢ Capteurs: Temp√©rature, humidit√©, pH, oxyg√®ne, GPS, pr√©sence, vibration, pression
‚Ä¢ Connectivit√©: Cartes SIM M2M, r√©seaux LPWAN, satellite
‚Ä¢ Plateformes: Cloud, On-Premise, analytics temps r√©el

CONNECTIVIT√â IoT:
Types r√©seaux:
- LAN (RFID, BLE, Zigbee): courte port√©e 1-100m, faible consommation
- PAN (Bluetooth): quelques m√®tres, √©quipements personnels
- WAN: port√©e √©tendue, dizaines m√®tres
- LPWAN (LoRa, Sigfox): longue port√©e, faible consommation, co√ªt r√©duit
- Satellite: couverture mondiale, zones isol√©es
- Cellulaire (2G/3G/4G): gros volumes donn√©es, longue distance

SIM M2M vs t√©l√©phone:
- SIM M2M: gestion distance, consommation optimis√©e, s√©curit√© renforc√©e
- SIM t√©l√©phone: communications mobiles classiques utilisateurs finaux

SERVICES:
‚Ä¢ Conseil et accompagnement projet
‚Ä¢ Installation et param√©trage
‚Ä¢ Formation utilisateurs
‚Ä¢ Support technique multilingue
‚Ä¢ Maintenance et mises √† jour`,

        scenarios: [
            {
                keywords: ['aquaculture', 'poisson', '√©levage', 'bassin', 'eau', 'fishflow'],
                response: `üêü AQUACULTURE INTELLIGENTE avec MIRASENS

Notre expertise aquacole comprend :

üìä SURVEILLANCE EAU 24/7:
‚Ä¢ Temp√©rature, pH, oxyg√®ne dissous
‚Ä¢ Ammoniac, nitrites, turbidit√©, conductivit√©
‚Ä¢ Alertes automatiques d√©passement seuils

ü§ñ GESTION ALIMENTATION:
‚Ä¢ Syst√®mes automatis√©s programmables
‚Ä¢ Optimisation nutriments selon croissance
‚Ä¢ √âconomies nourriture jusqu'√† 15%

üìà PLATEFORME FISHFLOW:
‚Ä¢ Tableaux bord temps r√©el personnalisables
‚Ä¢ IA pr√©dictive pour anticipation probl√®mes
‚Ä¢ G√©olocalisation √©quipements
‚Ä¢ Gestion droits acc√®s multi-utilisateurs

‚úÖ R√âSULTATS CLIENTS:
‚Ä¢ R√©duction mortalit√© 20-30%
‚Ä¢ Am√©lioration rendements 15-25%
‚Ä¢ ROI moyen 12-18 mois
‚Ä¢ Installation sans perturbation

Voulez-vous une d√©monstration personnalis√©e de FishFlow ou discuter de votre projet aquacole sp√©cifique ?`
            },
            {
                keywords: ['agriculture', 'ferme', 'culture', 'irrigation', 'sol', 'm√©t√©o'],
                response: `üå± AGRICULTURE DE PR√âCISION avec MIRASENS

Solutions compl√®tes pour optimiser vos cultures :

üå°Ô∏è SURVEILLANCE SOL:
‚Ä¢ Humidit√©, temp√©rature, pH, NPK
‚Ä¢ Capteurs multi-profondeurs
‚Ä¢ Cartes de fertilit√© d√©taill√©es

‚òî STATIONS M√âT√âO:
‚Ä¢ Pluie, vent, humidit√©, pression
‚Ä¢ Pr√©visions micro-climatiques
‚Ä¢ Alertes conditions d√©favorables

üíß IRRIGATION INTELLIGENTE:
‚Ä¢ Arrosage automatis√© selon besoins
‚Ä¢ √âconomies eau 20-40%
‚Ä¢ Zonage pr√©cis par parcelle

üî¨ SANT√â CULTURES:
‚Ä¢ D√©tection pr√©coce maladies
‚Ä¢ Surveillance parasites
‚Ä¢ Optimisation traitements

üìä PLATEFORME M-IoT:
‚Ä¢ Tableaux bord personnalis√©s
‚Ä¢ Analytics pr√©dictifs
‚Ä¢ Gestion multi-exploitations

‚úÖ B√âN√âFICES PROUV√âS:
‚Ä¢ +15-25% rendements
‚Ä¢ -30% consommation eau
‚Ä¢ -20% intrants chimiques
‚Ä¢ ROI 10-15 mois

Souhaitez-vous planifier une visite technique pour √©valuer vos besoins agricoles ?`
            },
            {
                keywords: ['industrie', 'maintenance', '√©quipement', 'production', 'pr√©dictive'],
                response: `üè≠ INDUSTRIE 4.0 avec MIRASENS

Transformez votre industrie avec l'IoT :

‚öôÔ∏è MAINTENANCE PR√âDICTIVE:
‚Ä¢ Capteurs vibration, temp√©rature, acoustique
‚Ä¢ IA pr√©diction pannes 24-72h avance
‚Ä¢ Planification maintenance optimale
‚Ä¢ R√©duction pannes non planifi√©es 50%

üìà MONITORING PRODUCTION:
‚Ä¢ Surveillance √©quipements temps r√©el
‚Ä¢ OEE (efficacit√© globale √©quipements)
‚Ä¢ Optimisation processus automatique
‚Ä¢ Tableaux bord directionnels

üîß GESTION ACTIFS:
‚Ä¢ Historique complet √©quipements
‚Ä¢ Co√ªts maintenance pr√©visionnels
‚Ä¢ Extension dur√©e vie machines
‚Ä¢ Int√©gration ERP/MES existants

üéØ R√âSULTATS IMM√âDIATS:
‚Ä¢ -50% arr√™ts non programm√©s
‚Ä¢ +20% efficacit√© production
‚Ä¢ -30% co√ªts maintenance
‚Ä¢ +15% dur√©e vie √©quipements

Formation √©quipes et support technique inclus. Voulez-vous une analyse de vos √©quipements critiques ?`
            },
            {
                keywords: ['logistique', 'transport', 'flotte', 'v√©hicule', 'suivi', 'cha√Æne', 'entrep√¥t'],
                response: `üöõ LOGISTIQUE 4.0 avec MIRASENS

Supply Chain intelligente et optimis√©e :

üìç TRA√áABILIT√â COMPL√àTE:
‚Ä¢ G√©olocalisation temps r√©el GPS
‚Ä¢ QR codes, RFID, capteurs IoT
‚Ä¢ Suivi produits bout en bout
‚Ä¢ Conformit√© normes s√©curit√©

‚ùÑÔ∏è CHA√éNE DU FROID:
‚Ä¢ Surveillance temp√©rature/humidit√©
‚Ä¢ Alertes d√©passement seuils
‚Ä¢ Tra√ßabilit√© r√©glementaire
‚Ä¢ R√©duction pertes 15-25%

üó∫Ô∏è OPTIMISATION ROUTES:
‚Ä¢ Algorithmes calcul trajets optimaux
‚Ä¢ R√©duction co√ªts transport 10-20%
‚Ä¢ Am√©lioration d√©lais livraison
‚Ä¢ Planification tourn√©es automatique

üìä DONN√âES COLLECT√âES:
‚Ä¢ Temp√©rature, humidit√©, chocs
‚Ä¢ G√©olocalisation, temps trajet
‚Ä¢ Consommation carburant, CO‚ÇÇ
‚Ä¢ Heures chargement/d√©chargement

üè≠ ENTREP√îTS CONNECT√âS:
‚Ä¢ Connectivit√© infrastructures existantes
‚Ä¢ Passerelles IoT, int√©gration API
‚Ä¢ Gestion stocks automatis√©e
‚Ä¢ WMS intelligent

‚úÖ B√âN√âFICES MESUR√âS:
‚Ä¢ -15% co√ªts logistiques
‚Ä¢ +25% visibilit√© cha√Æne
‚Ä¢ -30% ruptures stock
‚Ä¢ +20% satisfaction client

Solution SirGPS pour gestion flottes compl√®te. Souhaitez-vous une analyse de votre cha√Æne logistique ?`
            },
            {
                keywords: ['building', 'b√¢timent', '√©nergie', 'smart', 'bureau', '√©clairage', 'chauffage'],
                response: `üè¢ SMART BUILDING avec MIRASENS

B√¢timents intelligents et √©conomes :

üí° GESTION √âNERGIE:
‚Ä¢ Contr√¥le √©clairage automatique
‚Ä¢ Optimisation chauffage/climatisation
‚Ä¢ D√©tection pr√©sence multi-zones
‚Ä¢ √âconomies √©nerg√©tiques 20-40%

üå°Ô∏è CONFORT ENVIRONNEMENTAL:
‚Ä¢ Qualit√© air (CO‚ÇÇ, particules)
‚Ä¢ Temp√©rature, humidit√© optimales
‚Ä¢ √âclairage adaptatif naturel
‚Ä¢ Ambiance sonore contr√¥l√©e

üîí S√âCURIT√â INT√âGR√âE:
‚Ä¢ Contr√¥le acc√®s badges/biom√©trie
‚Ä¢ Surveillance p√©rim√®tre
‚Ä¢ D√©tection intrusion/incendie
‚Ä¢ Vid√©osurveillance intelligente

üìä OCCUPATION INTELLIGENTE:
‚Ä¢ Analyse flux personnes
‚Ä¢ Optimisation espaces travail
‚Ä¢ R√©servation salles automatique
‚Ä¢ Nettoyage adaptatif

Transformez vos b√¢timents en espaces intelligents et durables !`
            },
            {
                keywords: ['flotte', 'v√©hicule', 'gps', 'sirgps', 'carburant', 'conducteur'],
                response: `üöó GESTION DE FLOTTES avec SirGPS

Solution compl√®te de g√©olocalisation :

üìç SUIVI TEMPS R√âEL:
‚Ä¢ G√©olocalisation pr√©cise GPS
‚Ä¢ Historique trajets d√©taill√©
‚Ä¢ Zones g√©ographiques programmables
‚Ä¢ Alertes sorties p√©rim√®tre

‚õΩ OPTIMISATION CARBURANT:
‚Ä¢ Consommation par v√©hicule/conducteur
‚Ä¢ Eco-conduite avec scoring
‚Ä¢ D√©tection ralenti excessif
‚Ä¢ √âconomies carburant 15-25%

üîß MAINTENANCE PR√âVENTIVE:
‚Ä¢ Planification selon kilom√©trage
‚Ä¢ Alertes r√©visions programm√©es
‚Ä¢ Suivi co√ªts maintenance
‚Ä¢ Extension dur√©e vie v√©hicules

üì± APPLICATION MOBILE:
‚Ä¢ Interface conducteurs intuitive
‚Ä¢ Validation missions temps r√©el
‚Ä¢ Communication bidirectionnelle
‚Ä¢ Rapports activit√© automatiques

üìä TABLEAUX BORD DIRECTIONNELS:
‚Ä¢ Performances flotte globale
‚Ä¢ Co√ªts exploitation d√©taill√©s
‚Ä¢ Indicateurs s√©curit√© conduite
‚Ä¢ ROI et optimisations

SirGPS : la solution de r√©f√©rence pour ma√Ætriser vos co√ªts de flotte. D√©monstration gratuite disponible !`
            },
            {
                keywords: ['connectivit√©', 'r√©seau', 'lora', 'sigfox', 'sim', 'm2m', 'lpwan'],
                response: `üåê CONNECTIVIT√â IoT avec MIRASENS

Guide complet des technologies :

üì° R√âSEAUX DISPONIBLES:
‚Ä¢ LAN (RFID, BLE, Zigbee): 1-100m, faible consommation
‚Ä¢ PAN (Bluetooth): quelques m√®tres, √©quipements personnels  
‚Ä¢ LPWAN (LoRa, Sigfox): longue port√©e, batterie 10+ ans
‚Ä¢ Cellulaire (2G/3G/4G): gros volumes, couverture nationale
‚Ä¢ Satellite: zones isol√©es, couverture mondiale

üéØ CHOIX PAR USAGE:
‚Ä¢ Bureau: WiFi, Ethernet
‚Ä¢ Agriculture: LoRaWAN, Sigfox  
‚Ä¢ Industrie: WiFi, cellulaire
‚Ä¢ Logistique: GPS, cellulaire
‚Ä¢ Maison: Zigbee, WiFi

üì± SIM M2M vs T√âL√âPHONE:
SIM M2M : gestion distance, optimisation donn√©es, s√©curit√©
SIM t√©l√©phone : communications classiques utilisateurs

üîí S√âCURIT√â:
‚Ä¢ APN priv√© pour connexions s√©curis√©es
‚Ä¢ Chiffrement bout en bout
‚Ä¢ Authentification renforc√©e
‚Ä¢ Surveillance flux donn√©es

Nous vous accompagnons dans le choix optimal selon vos contraintes techniques et √©conomiques !`
            },
            {
                keywords: ['prix', 'co√ªt', 'tarif', 'budget', 'devis', 'abonnement'],
                response: `üí∞ TARIFICATION MIRASENS

Pricing transparent et modulaire :

üìä FACTEURS TARIFAIRES:
‚Ä¢ Nombre capteurs/objets connect√©s
‚Ä¢ Type connectivit√© (LoRa, cellulaire, WiFi)
‚Ä¢ Fonctionnalit√©s plateforme requises
‚Ä¢ Services accompagnement souhait√©s
‚Ä¢ Mode h√©bergement (SaaS/On-Premise)

üí° MOD√àLES √âCONOMIQUES:
‚Ä¢ SaaS : Abonnement mensuel, maintenance incluse
‚Ä¢ On-Premise : Licence unique, serveurs clients
‚Ä¢ Hybride : Mix cloud/local selon besoins

üéØ EXEMPLES INDICATIFS:
‚Ä¢ Starter (5-20 capteurs) : 200-500‚Ç¨/mois
‚Ä¢ Business (50-200 capteurs) : 800-2000‚Ç¨/mois  
‚Ä¢ Enterprise (500+ capteurs) : Sur devis

‚úÖ INCLUS SYST√âMATIQUEMENT:
‚Ä¢ Formation utilisateurs
‚Ä¢ Support technique multilingue
‚Ä¢ Mises √† jour r√©guli√®res
‚Ä¢ Garantie mat√©riel 2-3 ans

üìû DEVIS PERSONNALIS√â:
Chaque projet √©tant unique, je peux vous mettre en contact avec notre √©quipe commerciale pour une analyse d√©taill√©e et un devis sur mesure.

Pouvez-vous me pr√©ciser votre secteur d'activit√© et le nombre approximatif d'objets √† connecter ?`
            },
            {
                keywords: ['fishflow', 'plateforme', 'aquaculture', 'supervision'],
                response: `üêü PLATEFORME FISHFLOW

Solution d√©di√©e aquaculture/agriculture :

üéØ FONCTIONNALIT√âS CL√âS:
‚Ä¢ Supervision multi-√©quipements et r√©seaux
‚Ä¢ Analyse donn√©es temps r√©el
‚Ä¢ Tableaux bord personnalisables
‚Ä¢ Syst√®me alertes avanc√©
‚Ä¢ IA pr√©dictive embarqu√©e

üìä WIDGETS DISPONIBLES:
‚Ä¢ Graphiques temporels, jauges analogiques
‚Ä¢ Cartes g√©ographiques dynamiques
‚Ä¢ Timelines √©v√©nements
‚Ä¢ Indicateurs chiffr√©s color√©s
‚Ä¢ Alarmes visuelles/sonores

ü§ñ INTELLIGENCE ARTIFICIELLE:
‚Ä¢ Pr√©diction param√®tres eau
‚Ä¢ Anticipation probl√®mes √©quipements
‚Ä¢ Optimisation alimentation automatique
‚Ä¢ Algorithmes apprentissage adaptatifs

üèóÔ∏è H√âBERGEMENT AU CHOIX:
‚Ä¢ SaaS : Acc√®s cloud, abonnement mensuel
‚Ä¢ On-Premise : Serveurs locaux, licence unique
‚Ä¢ Hybride : Combinaison selon besoins

üîê S√âCURIT√â & ACC√àS:
‚Ä¢ Gestion droits utilisateurs granulaire
‚Ä¢ Authentification multi-facteurs
‚Ä¢ Sauvegarde donn√©es automatique
‚Ä¢ Conformit√© RGPD

‚úÖ AVANTAGES CLIENTS:
‚Ä¢ R√©duction mortalit√© 20-30%
‚Ä¢ Optimisation croissance
‚Ä¢ √âconomies ressources 15-25%
‚Ä¢ ROI 12-18 mois

D√©monstration live disponible ! Souhaitez-vous voir FishFlow en action ?`
            },
            {
                keywords: ['miot', 'm-iot', 'plateforme', 'multi-objets'],
                response: `üìä PLATEFORME M-IoT

Solution universelle multi-objets :

üåê CONNECTIVIT√â UNIVERSELLE:
‚Ä¢ Support tous protocoles (LoRa, Sigfox, WiFi, 4G)
‚Ä¢ Passerelles multi-r√©seaux
‚Ä¢ Int√©gration objets h√©t√©rog√®nes
‚Ä¢ APIs ouvertes standard

üìà VISUALISATION AVANC√âE:
‚Ä¢ Tableaux bord configurables
‚Ä¢ Graphiques temps r√©el interactifs
‚Ä¢ Cartes g√©ographiques
‚Ä¢ Alertes intelligentes
‚Ä¢ Rapports automatis√©s

üîß GESTION SIMPLIFI√âE:
‚Ä¢ Interface intuitive drag & drop
‚Ä¢ Configuration capteurs distance
‚Ä¢ Mise √† jour OTA (Over The Air)
‚Ä¢ Supervision √©tat √©quipements

üéØ SECTEURS COMPATIBLES:
‚Ä¢ Agriculture : irrigation, m√©t√©o, sol
‚Ä¢ Industrie : machines, maintenance
‚Ä¢ Ville : √©clairage, d√©chets, parking
‚Ä¢ Environnement : qualit√© air, eau

‚öôÔ∏è INT√âGRATIONS:
‚Ä¢ ERP/CRM existants
‚Ä¢ Bases donn√©es externes
‚Ä¢ Syst√®mes tiers via API
‚Ä¢ Export formats standards

Solution √©volutive adapt√©e √† tous projets IoT !`
            },
            {
                keywords: ['sirgps', 'gestion', 'flotte', 'g√©olocalisation', 'gps'],
                response: `üìç APPLICATION SirGPS

Gestion de flottes nouvelle g√©n√©ration :

üöó SUIVI V√âHICULES:
‚Ä¢ G√©olocalisation temps r√©el pr√©cise
‚Ä¢ Historique trajets d√©taill√©
‚Ä¢ Vitesses, arr√™ts, kilom√©trage
‚Ä¢ Zones g√©ographiques programmables

‚õΩ √âCONOMIES CARBURANT:
‚Ä¢ Consommation par v√©hicule/conducteur
‚Ä¢ Score √©co-conduite personnalis√©
‚Ä¢ D√©tection ralenti excessif
‚Ä¢ Optimisation trajets automatique

üì± APPLICATION MOBILE:
‚Ä¢ Interface conducteurs ergonomique
‚Ä¢ Validation missions terrain
‚Ä¢ Communication instant
‚Ä¢ G√©olocalisation pr√©cise

üîß MAINTENANCE INTELLIGENTE:
‚Ä¢ Planification selon usage r√©el
‚Ä¢ Alertes r√©visions automatiques
‚Ä¢ Suivi co√ªts d√©taill√©
‚Ä¢ Historique interventions

üìä REPORTING AVANC√â:
‚Ä¢ Tableaux bord temps r√©el
‚Ä¢ Analyses performances flotte
‚Ä¢ Co√ªts exploitation d√©taill√©s
‚Ä¢ Indicateurs s√©curit√©

üéØ B√âN√âFICES MESUR√âS:
‚Ä¢ -15% co√ªts carburant
‚Ä¢ -25% temps administratif
‚Ä¢ +30% efficacit√© tourn√©es
‚Ä¢ ROI 6-12 mois

Version d√©mo gratuite 30 jours ! Testez SirGPS sans engagement.`
            }
        ]
    },
    en: {
        company: `MIRASENS is a company specialized in Internet of Things (IoT) and M2M connectivity solutions based in Dounia Parc, Dely Brahim, Algiers, Algeria.

CONTACT:
Phone: (+213) 560-555-300
Email: contact@mirasens.com
Website: www.mirasens.com

DETAILED BUSINESS SECTORS:

üêü SMART AQUACULTURE:
Technologies: Water quality monitoring, fish growth tracking, automated feeding systems
‚Ä¢ Water monitoring: Temperature, pH, dissolved oxygen, ammonia, nitrites, turbidity, conductivity
‚Ä¢ Feed management: Automated programmable systems, nutrient optimization
‚Ä¢ Fish growth: Biometric tracking, behavior analysis
‚Ä¢ Dedicated FishFlow platform
Aquaculture FAQ:
- Sensors monitor temperature, pH, oxygen, conductivity in real-time
- Automatic alerts when thresholds exceeded
- Mortality reduction up to 30%, improved yields
- Compatible with existing ponds, simple installation
- Average ROI 12-18 months

üå± SMART AGRICULTURE:
Technologies: Soil monitoring, irrigation optimization, crop health analysis
‚Ä¢ Soil monitoring: Moisture, temperature, nutrient levels, pH
‚Ä¢ Weather stations: Rain, wind, humidity, atmospheric pressure
‚Ä¢ Smart irrigation: Automated control based on conditions
‚Ä¢ Crop health: Early detection of diseases/pests
Agriculture FAQ:
- Soil sensors monitor moisture, temperature, NPK
- Water savings 20-40%, yield improvements 15-25%
- Installation without disrupting existing crops
- Compatibility with current irrigation systems
- Technical support and training included

üè≠ SMART INDUSTRY:
Technologies: Predictive maintenance, equipment monitoring, production optimization
‚Ä¢ Vibration, temperature, pressure, acoustic sensors
‚Ä¢ AI algorithms for failure prediction
‚Ä¢ Real-time dashboards
‚Ä¢ Production process optimization
Industry FAQ:
- Reduce unplanned failures up to 50%
- Optimize maintenance, extend equipment life
- 24/7 continuous monitoring with alerts
- Integration with existing ERP/MES
- Maintenance team training

üöõ SMART LOGISTICS:
Technologies: Asset tracking, route optimization, cold chain monitoring
‚Ä¢ Real-time GPS vehicle/goods tracking
‚Ä¢ Cold chain temperature monitoring
‚Ä¢ Route/delivery optimization
- Complete fleet management
Logistics FAQ:
- Complete product traceability via IoT/RFID/QR codes
- Reduce transport costs, improve delivery times
- Data collection: temperature, humidity, geolocation, consumption
- Connect existing warehouses via gateways/APIs
- Implementation: needs analysis ‚Üí sensors ‚Üí pilot ‚Üí deployment

üè¢ SMART BUILDING:
Technologies: Energy management, security systems, occupancy optimization
‚Ä¢ Lighting, heating, air conditioning control
‚Ä¢ Presence detection, air quality
‚Ä¢ Access security, surveillance
‚Ä¢ Energy consumption optimization

üöó FLEET MANAGEMENT:
Technologies: Vehicle tracking, fuel optimization, maintenance planning
‚Ä¢ Real-time geolocation
‚Ä¢ Fuel consumption, eco-driving
‚Ä¢ Preventive maintenance
‚Ä¢ Optimal route planning

DETAILED SOFTWARE SOLUTIONS:

üêü FISHFLOW - Aquaculture/agriculture platform:
‚Ä¢ Multi-equipment and multi-network supervision
‚Ä¢ Real-time data analysis, decision support
‚Ä¢ Customizable dashboards
‚Ä¢ Performance alert system
‚Ä¢ Widgets: charts, gauges, maps, timelines
‚Ä¢ Dynamic object location
‚Ä¢ User access rights management
‚Ä¢ Embedded AI for predictions
‚Ä¢ Automated feed management
‚Ä¢ Hosting: SaaS (subscription) or On-Premise (license)

üìä M-IoT - All-in-one platform:
‚Ä¢ Multi-object management and visualization
‚Ä¢ Multi-protocol connectivity
‚Ä¢ Advanced analytics
‚Ä¢ Configurable dashboards
‚Ä¢ Smart alerts

üìç SirGPS - Fleet management:
‚Ä¢ Web/mobile application
‚Ä¢ Real-time geolocation
‚Ä¢ Route optimization
‚Ä¢ Fuel management
‚Ä¢ Vehicle maintenance
‚Ä¢ Detailed reports

SUPPORTED TECHNOLOGIES:
‚Ä¢ Protocols: LoRaWAN, Sigfox, NB-IoT, LTE-M, WiFi, Bluetooth, RFID
‚Ä¢ Sensors: Temperature, humidity, pH, oxygen, GPS, presence, vibration, pressure
‚Ä¢ Connectivity: M2M SIM cards, LPWAN networks, satellite
‚Ä¢ Platforms: Cloud, On-Premise, real-time analytics

IoT CONNECTIVITY:
Network types:
- LAN (RFID, BLE, Zigbee): short range 1-100m, low consumption
- PAN (Bluetooth): few meters, personal equipment
- WAN: extended range, tens of meters
- LPWAN (LoRa, Sigfox): long range, low consumption, reduced cost
- Satellite: worldwide coverage, isolated areas
- Cellular (2G/3G/4G): large data volumes, long distance

M2M vs phone SIM:
- M2M SIM: remote management, optimized consumption, enhanced security
- Phone SIM: classic mobile communications for end users

SERVICES:
‚Ä¢ Project consulting and support
‚Ä¢ Installation and configuration
‚Ä¢ User training
‚Ä¢ Multilingual technical support
‚Ä¢ Maintenance and updates`,

        scenarios: [
            {
                keywords: ['aquaculture', 'fish', 'farming', 'pond', 'water', 'fishflow'],
                response: `üêü SMART AQUACULTURE with MIRASENS

Our aquaculture expertise includes:

üìä 24/7 WATER MONITORING:
‚Ä¢ Temperature, pH, dissolved oxygen
‚Ä¢ Ammonia, nitrites, turbidity, conductivity
‚Ä¢ Automatic threshold alerts

ü§ñ FEED MANAGEMENT:
‚Ä¢ Programmable automated systems
‚Ä¢ Nutrient optimization for growth
‚Ä¢ Feed savings up to 15%

üìà FISHFLOW PLATFORM:
‚Ä¢ Real-time customizable dashboards
‚Ä¢ Predictive AI for problem anticipation
‚Ä¢ Equipment geolocation
‚Ä¢ Multi-user access management

‚úÖ CLIENT RESULTS:
‚Ä¢ 20-30% mortality reduction
‚Ä¢ 15-25% yield improvement
‚Ä¢ Average ROI 12-18 months
‚Ä¢ Installation without disruption

Would you like a personalized FishFlow demonstration or to discuss your specific aquaculture project?`
            },
            {
                keywords: ['agriculture', 'farm', 'crop', 'irrigation', 'soil', 'weather'],
                response: `üå± PRECISION AGRICULTURE with MIRASENS

Complete solutions to optimize your crops:

üå°Ô∏è SOIL MONITORING:
‚Ä¢ Moisture, temperature, pH, NPK
‚Ä¢ Multi-depth sensors
‚Ä¢ Detailed fertility maps

‚òî WEATHER STATIONS:
‚Ä¢ Rain, wind, humidity, pressure
‚Ä¢ Micro-climate predictions
‚Ä¢ Adverse condition alerts

üíß SMART IRRIGATION:
‚Ä¢ Automated watering based on needs
‚Ä¢ 20-40% water savings
‚Ä¢ Precise zoning per plot

üî¨ CROP HEALTH:
‚Ä¢ Early disease detection
‚Ä¢ Pest monitoring
‚Ä¢ Treatment optimization

üìä M-IoT PLATFORM:
‚Ä¢ Customized dashboards
‚Ä¢ Predictive analytics
‚Ä¢ Multi-farm management

‚úÖ PROVEN BENEFITS:
‚Ä¢ +15-25% yields
‚Ä¢ -30% water consumption
‚Ä¢ -20% chemical inputs
‚Ä¢ ROI 10-15 months

Would you like to schedule a technical visit to assess your agricultural needs?`
            },
            {
                keywords: ['industry', 'maintenance', 'equipment', 'production', 'predictive'],
                response: `üè≠ INDUSTRY 4.0 with MIRASENS

Transform your industry with IoT:

‚öôÔ∏è PREDICTIVE MAINTENANCE:
‚Ä¢ Vibration, temperature, acoustic sensors
‚Ä¢ AI failure prediction 24-72h advance
‚Ä¢ Optimal maintenance planning
‚Ä¢ 50% unplanned failure reduction

üìà PRODUCTION MONITORING:
‚Ä¢ Real-time equipment monitoring
‚Ä¢ OEE (Overall Equipment Effectiveness)
‚Ä¢ Automatic process optimization
‚Ä¢ Executive dashboards

üîß ASSET MANAGEMENT:
‚Ä¢ Complete equipment history
‚Ä¢ Predictive maintenance costs
‚Ä¢ Extended machine life
‚Ä¢ ERP/MES integration

üéØ IMMEDIATE RESULTS:
‚Ä¢ -50% unscheduled downtime
‚Ä¢ +20% production efficiency
‚Ä¢ -30% maintenance costs
‚Ä¢ +15% equipment lifespan

Team training and technical support included. Would you like an analysis of your critical equipment?`
            },
            {
                keywords: ['logistics', 'transport', 'fleet', 'vehicle', 'tracking', 'chain', 'warehouse'],
                response: `üöõ LOGISTICS 4.0 with MIRASENS

Intelligent and optimized supply chain:

üìç COMPLETE TRACEABILITY:
‚Ä¢ Real-time GPS geolocation
‚Ä¢ QR codes, RFID, IoT sensors
‚Ä¢ End-to-end product tracking
‚Ä¢ Safety standards compliance

‚ùÑÔ∏è COLD CHAIN:
‚Ä¢ Temperature/humidity monitoring
‚Ä¢ Threshold alerts
‚Ä¢ Regulatory traceability
‚Ä¢ 15-25% loss reduction

üó∫Ô∏è ROUTE OPTIMIZATION:
‚Ä¢ Optimal path calculation algorithms
‚Ä¢ 10-20% transport cost reduction
‚Ä¢ Improved delivery times
‚Ä¢ Automatic route planning

üìä DATA COLLECTED:
‚Ä¢ Temperature, humidity, shocks
‚Ä¢ Geolocation, travel time
‚Ä¢ Fuel consumption, CO‚ÇÇ
‚Ä¢ Loading/unloading hours

üè≠ CONNECTED WAREHOUSES:
‚Ä¢ Existing infrastructure connectivity
‚Ä¢ IoT gateways, API integration
‚Ä¢ Automated inventory management
‚Ä¢ Intelligent WMS

‚úÖ MEASURED BENEFITS:
‚Ä¢ -15% logistics costs
‚Ä¢ +25% chain visibility
‚Ä¢ -30% stock-outs
‚Ä¢ +20% customer satisfaction

SirGPS solution for complete fleet management. Would you like an analysis of your logistics chain?`
            },
            {
                keywords: ['building', 'energy', 'smart', 'office', 'lighting', 'heating'],
                response: `üè¢ SMART BUILDING with MIRASENS

Intelligent and economical buildings:

üí° ENERGY MANAGEMENT:
‚Ä¢ Automatic lighting control
‚Ä¢ Heating/air conditioning optimization
‚Ä¢ Multi-zone presence detection
‚Ä¢ 20-40% energy savings

üå°Ô∏è ENVIRONMENTAL COMFORT:
‚Ä¢ Air quality (CO‚ÇÇ, particles)
‚Ä¢ Optimal temperature, humidity
‚Ä¢ Adaptive natural lighting
‚Ä¢ Controlled sound environment

üîí INTEGRATED SECURITY:
‚Ä¢ Badge/biometric access control
‚Ä¢ Perimeter surveillance
‚Ä¢ Intrusion/fire detection
‚Ä¢ Intelligent video surveillance

üìä SMART OCCUPANCY:
‚Ä¢ People flow analysis
‚Ä¢ Workspace optimization
‚Ä¢ Automatic room booking
‚Ä¢ Adaptive cleaning

Transform your buildings into intelligent and sustainable spaces!`
            },
            {
                keywords: ['fleet', 'vehicle', 'gps', 'sirgps', 'fuel', 'driver'],
                response: `üöó FLEET MANAGEMENT with SirGPS

Complete geolocation solution:

üìç REAL-TIME TRACKING:
‚Ä¢ Precise GPS geolocation
‚Ä¢ Detailed route history
‚Ä¢ Programmable geographic zones
‚Ä¢ Perimeter exit alerts

‚õΩ FUEL OPTIMIZATION:
‚Ä¢ Consumption per vehicle/driver
‚Ä¢ Eco-driving with scoring
‚Ä¢ Excessive idling detection
‚Ä¢ 15-25% fuel savings

üîß PREVENTIVE MAINTENANCE:
‚Ä¢ Mileage-based planning
‚Ä¢ Scheduled service alerts
‚Ä¢ Maintenance cost tracking
‚Ä¢ Extended vehicle life

üì± MOBILE APPLICATION:
‚Ä¢ Intuitive driver interface
‚Ä¢ Real-time mission validation
‚Ä¢ Bidirectional communication
‚Ä¢ Automatic activity reports

üìä EXECUTIVE DASHBOARDS:
‚Ä¢ Global fleet performance
‚Ä¢ Detailed operating costs
‚Ä¢ Driving safety indicators
‚Ä¢ ROI and optimizations

SirGPS: the reference solution for controlling your fleet costs. Free demonstration available!`
            },
            {
                keywords: ['connectivity', 'network', 'lora', 'sigfox', 'sim', 'm2m', 'lpwan'],
                response: `üåê IoT CONNECTIVITY with MIRASENS

Complete technology guide:

üì° AVAILABLE NETWORKS:
‚Ä¢ LAN (RFID, BLE, Zigbee): 1-100m, low consumption
‚Ä¢ PAN (Bluetooth): few meters, personal equipment
‚Ä¢ LPWAN (LoRa, Sigfox): long range, 10+ year battery
‚Ä¢ Cellular (2G/3G/4G): large volumes, national coverage
‚Ä¢ Satellite: isolated areas, worldwide coverage

üéØ CHOICE BY USE:
‚Ä¢ Office: WiFi, Ethernet
‚Ä¢ Agriculture: LoRaWAN, Sigfox
‚Ä¢ Industry: WiFi, cellular
‚Ä¢ Logistics: GPS, cellular
‚Ä¢ Home: Zigbee, WiFi

üì± M2M vs PHONE SIM:
M2M SIM: remote management, data optimization, security
Phone SIM: classic user communications

üîí SECURITY:
‚Ä¢ Private APN for secure connections
‚Ä¢ End-to-end encryption
‚Ä¢ Enhanced authentication
‚Ä¢ Data flow monitoring

We support you in choosing optimally according to your technical and economic constraints!`
            },
            {
                keywords: ['price', 'cost', 'pricing', 'budget', 'quote', 'subscription'],
                response: `üí∞ MIRASENS PRICING

Transparent and modular pricing:

üìä PRICING FACTORS:
‚Ä¢ Number of sensors/connected objects
‚Ä¢ Connectivity type (LoRa, cellular, WiFi)
‚Ä¢ Required platform features
‚Ä¢ Desired support services
‚Ä¢ Hosting mode (SaaS/On-Premise)

üí° ECONOMIC MODELS:
‚Ä¢ SaaS: Monthly subscription, maintenance included
‚Ä¢ On-Premise: One-time license, client servers
‚Ä¢ Hybrid: Cloud/local mix per needs

üéØ INDICATIVE EXAMPLES:
‚Ä¢ Starter (5-20 sensors): ‚Ç¨200-500/month
‚Ä¢ Business (50-200 sensors): ‚Ç¨800-2000/month
‚Ä¢ Enterprise (500+ sensors): Custom quote

‚úÖ ALWAYS INCLUDED:
‚Ä¢ User training
‚Ä¢ Multilingual technical support
‚Ä¢ Regular updates
‚Ä¢ 2-3 year hardware warranty

üìû PERSONALIZED QUOTE:
Each project being unique, I can connect you with our sales team for detailed analysis and custom quote.

Can you specify your business sector and approximate number of objects to connect?`
            },
            {
                keywords: ['fishflow', 'platform', 'aquaculture', 'supervision'],
                response: `üêü FISHFLOW PLATFORM

Dedicated aquaculture/agriculture solution:

üéØ KEY FEATURES:
‚Ä¢ Multi-equipment and network supervision
‚Ä¢ Real-time data analysis
‚Ä¢ Customizable dashboards
‚Ä¢ Advanced alert system
‚Ä¢ Embedded predictive AI

üìä AVAILABLE WIDGETS:
‚Ä¢ Temporal charts, analog gauges
‚Ä¢ Dynamic geographic maps
‚Ä¢ Event timelines
‚Ä¢ Colored numerical indicators
‚Ä¢ Visual/audio alarms

ü§ñ ARTIFICIAL INTELLIGENCE:
‚Ä¢ Water parameter prediction
‚Ä¢ Equipment problem anticipation
‚Ä¢ Automatic feed optimization
‚Ä¢ Adaptive learning algorithms

üèóÔ∏è HOSTING OPTIONS:
‚Ä¢ SaaS: Cloud access, monthly subscription
‚Ä¢ On-Premise: Local servers, one-time license
‚Ä¢ Hybrid: Combination per needs

üîê SECURITY & ACCESS:
‚Ä¢ Granular user rights management
‚Ä¢ Multi-factor authentication
‚Ä¢ Automatic data backup
‚Ä¢ GDPR compliance

‚úÖ CLIENT BENEFITS:
‚Ä¢ 20-30% mortality reduction
‚Ä¢ Growth optimization
‚Ä¢ 15-25% resource savings
‚Ä¢ 12-18 month ROI

Live demonstration available! Would you like to see FishFlow in action?`
            },
            {
                keywords: ['miot', 'm-iot', 'platform', 'multi-objects'],
                response: `üìä M-IoT PLATFORM

Universal multi-object solution:

üåê UNIVERSAL CONNECTIVITY:
‚Ä¢ Support all protocols (LoRa, Sigfox, WiFi, 4G)
‚Ä¢ Multi-network gateways
‚Ä¢ Heterogeneous object integration
‚Ä¢ Open standard APIs

üìà ADVANCED VISUALIZATION:
‚Ä¢ Configurable dashboards
‚Ä¢ Interactive real-time charts
‚Ä¢ Geographic maps
‚Ä¢ Smart alerts
‚Ä¢ Automated reports

üîß SIMPLIFIED MANAGEMENT:
‚Ä¢ Intuitive drag & drop interface
‚Ä¢ Remote sensor configuration
‚Ä¢ OTA (Over The Air) updates
‚Ä¢ Equipment status supervision

üéØ COMPATIBLE SECTORS:
‚Ä¢ Agriculture: irrigation, weather, soil
‚Ä¢ Industry: machines, maintenance
‚Ä¢ City: lighting, waste, parking
‚Ä¢ Environment: air quality, water

‚öôÔ∏è INTEGRATIONS:
‚Ä¢ Existing ERP/CRM
‚Ä¢ External databases
‚Ä¢ Third-party systems via API
‚Ä¢ Standard format export

Scalable solution adapted to all IoT projects!`
            },
            {
                keywords: ['sirgps', 'management', 'fleet', 'geolocation', 'gps'],
                response: `üìç SirGPS APPLICATION

Next-generation fleet management:

üöó VEHICLE TRACKING:
‚Ä¢ Precise real-time geolocation
‚Ä¢ Detailed route history
‚Ä¢ Speeds, stops, mileage
‚Ä¢ Programmable geographic zones

‚õΩ FUEL SAVINGS:
‚Ä¢ Consumption per vehicle/driver
‚Ä¢ Personalized eco-driving score
‚Ä¢ Excessive idling detection
‚Ä¢ Automatic route optimization

üì± MOBILE APPLICATION:
‚Ä¢ Ergonomic driver interface
‚Ä¢ Field mission validation
‚Ä¢ Instant communication
‚Ä¢ Precise geolocation

üîß INTELLIGENT MAINTENANCE:
‚Ä¢ Planning based on actual usage
‚Ä¢ Automatic service alerts
‚Ä¢ Detailed cost tracking
‚Ä¢ Intervention history

üìä ADVANCED REPORTING:
‚Ä¢ Real-time dashboards
‚Ä¢ Fleet performance analysis
‚Ä¢ Detailed operating costs
‚Ä¢ Safety indicators

üéØ MEASURED BENEFITS:
‚Ä¢ -15% fuel costs
‚Ä¢ -25% administrative time
‚Ä¢ +30% route efficiency
‚Ä¢ 6-12 month ROI

30-day free demo version! Test SirGPS without commitment.`
            }
        ]
    }
};

// Language detection function
function detectLanguage(message) {
    const frenchWords = ['je', 'vous', 'le', 'la', 'les', 'un', 'une', 'et', 'de', 'du', 'des', 'avec', 'pour', 'dans', 'sur', '√™tre', 'avoir', 'faire', 'aller', 'pouvoir', 'vouloir', 'savoir', 'devoir', 'prendre', 'venir', 'voir', 'donner', 'parler', 'aimer', 'passer', 'mettre', 'dire', 'partir', 'sortir', 'entrer', 'rester', 'tomber', 'devenir', 'tenir', 'sembler', 'laisser', 'porter', 'suivre', 'vivre', 'mourir', 'na√Ætre', 'conna√Ætre', 'para√Ætre', 'choisir', 'r√©ussir', 'finir', 'grandir', 'sentir', 'dormir', 'servir', 'mentir', 'partir', 'sortir'];
    const englishWords = ['i', 'you', 'he', 'she', 'it', 'we', 'they', 'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'among', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'get', 'go', 'come', 'take', 'give', 'make', 'know', 'think', 'see', 'look', 'want', 'need', 'try', 'work', 'use', 'find', 'help', 'ask', 'seem', 'feel', 'try', 'leave', 'call'];
    
    const messageLower = message.toLowerCase();
    const words = messageLower.split(/\s+/);
    
    let frenchScore = 0;
    let englishScore = 0;
    
    words.forEach(word => {
        if (frenchWords.includes(word)) frenchScore++;
        if (englishWords.includes(word)) englishScore++;
    });
    
    return frenchScore > englishScore ? 'fr' : 'en';
}

// Find relevant scenario
function findRelevantScenario(message, language) {
    const knowledge = MIRASENS_KNOWLEDGE[language];
    const messageLower = message.toLowerCase();
    
    for (const scenario of knowledge.scenarios) {
        if (scenario.keywords.some(keyword => messageLower.includes(keyword))) {
            return scenario.response;
        }
    }
    return null;
}

// Chat endpoint
app.post('/api/chat', async (req, res) => {
    try {
        const { message, conversationHistory = [], language } = req.body;
        
        if (!message || typeof message !== 'string') {
            return res.status(400).json({ 
                error: 'Message is required and must be a string' 
            });
        }

        // Use provided language or detect it from message
        const detectedLanguage = language && ['fr', 'en'].includes(language) 
            ? language 
            : detectLanguage(message);
        const knowledge = MIRASENS_KNOWLEDGE[language];
        
        // Check for relevant scenario first
        const scenarioResponse = findRelevantScenario(message, detectedLanguage);
        if (scenarioResponse) {
            return res.json({
                response: scenarioResponse,
                language: detectedLanguage
            });
        }

        // If no Gemini API available, provide demo response
        if (!model) {
            const demoResponse = detectedLanguage === 'fr' 
                ? `Merci pour votre message ! Je suis actuellement en mode d√©monstration. Pour une r√©ponse personnalis√©e de l'IA, veuillez configurer une cl√© API Google Gemini.

Cependant, je peux vous dire que MIRASENS propose des solutions IoT innovantes pour :
‚Ä¢ Smart Aquaculture avec FishFlow
‚Ä¢ Smart Agriculture et surveillance des sols
‚Ä¢ Smart Industry et maintenance pr√©dictive
‚Ä¢ Smart Logistique et gestion de flotte

Contactez-nous au (+213) 560-555-300 ou contact@mirasens.com pour plus d'informations !`
                : `Thank you for your message! I'm currently in demo mode. For personalized AI responses, please configure a Google Gemini API key.

However, I can tell you that MIRASENS offers innovative IoT solutions for:
‚Ä¢ Smart Aquaculture with FishFlow
‚Ä¢ Smart Agriculture and soil monitoring
‚Ä¢ Smart Industry and predictive maintenance
‚Ä¢ Smart Logistics and fleet management

Contact us at (+213) 560-555-300 or contact@mirasens.com for more information!`;

            return res.json({
                response: demoResponse,
                language: detectedLanguage
            });
        }

        // Build conversation context
        let conversationContext = '';
        if (conversationHistory.length > 0) {
            conversationContext = '\n\nPrevious conversation:\n' + 
                conversationHistory.slice(-6).map(msg => 
                    `${msg.role}: ${msg.content}`
                ).join('\n');
        }

        // Create prompt for Gemini
        const prompt = `You are MIRASENS AI Assistant, a helpful chatbot for MIRASENS company. 

IMPORTANT INSTRUCTIONS:
- Always respond in ${detectedLanguage === 'fr' ? 'French' : 'English'}
- Be professional, helpful, and knowledgeable about IoT solutions
- Keep responses concise but informative (max 300 words)
- Always offer to connect the user with experts for detailed discussions
- Focus on MIRASENS solutions and expertise

COMPANY KNOWLEDGE:
${knowledge.company}

USER MESSAGE: ${message}
${conversationContext}

Provide a helpful response about MIRASENS IoT solutions. If you don't have specific information, offer to connect them with our experts.`;

        // Generate response using Gemini
        const result = await model.generateContent(prompt);
        const response = await result.response;
        const aiResponse = response.text();

        res.json({
            response: aiResponse,
            language: detectedLanguage
        });

    } catch (error) {
        console.error('Chat API Error:', error);
        
        // Language-specific error messages
        const errorMessage = detectedLanguage === 'fr' 
            ? 'D√©sol√©, je rencontre un probl√®me technique. Veuillez r√©essayer dans quelques instants.'
            : 'Sorry, I\'m experiencing a technical issue. Please try again in a few moments.';
            
        res.status(500).json({ 
            error: errorMessage 
        });
    }
});

// Health check endpoint
app.get('/api/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        timestamp: new Date().toISOString(),
        service: 'MIRASENS Chatbot API'
    });
});

// Error handling middleware
app.use((err, req, res, next) => {
    console.error('Server Error:', err);
    res.status(500).json({ 
        error: 'Internal server error' 
    });
});

// 404 handler
app.use('*', (req, res) => {
    res.status(404).json({ 
        error: 'Endpoint not found' 
    });
});

app.listen(PORT, () => {
    console.log(`MIRASENS Chatbot Server running on port ${PORT}`);
    console.log(`Environment: ${process.env.NODE_ENV || 'development'}`);
});

module.exports = app;
